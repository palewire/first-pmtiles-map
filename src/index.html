<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>First PMTiles Map</title>
    <script src="https://unpkg.com/maplibre-gl@5.15.0/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@3/dist/pmtiles.js"></script>
    <link
      href="https://unpkg.com/maplibre-gl@5.15.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
      }
      #map {
        position: absolute;
        inset: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      // Register PMTiles protocol so the vector source can load .pmtiles directly
      const protocol = new pmtiles.Protocol();
      maplibregl.addProtocol("pmtiles", protocol.tile);

      // Use a relative URL so it works on GitHub Pages subpaths
      const stormsHttpUrl = new URL("ibtracs.pmtiles", window.location.href)
        .href;
      const stormsTilesUrl = `pmtiles://${stormsHttpUrl}`;
      protocol.add(new pmtiles.PMTiles(stormsHttpUrl));

      // Globe rotation
      function createGlobeSpinner(map, degreesPerSecond = 10) {
        let animationId = null;
        let lastTime;

        function spin() {
          const now = performance.now();
          const elapsed = (now - lastTime) / 1000;
          lastTime = now;
          const center = map.getCenter();
          center.lng += degreesPerSecond * elapsed;
          map.setCenter(center);
          animationId = requestAnimationFrame(spin);
        }

        return {
          start() {
            if (!animationId) {
              lastTime = performance.now();
              spin();
            }
          },
          stop() {
            if (animationId) {
              cancelAnimationFrame(animationId);
              animationId = null;
            }
          },
        };
      }

      fetch("https://tiles.openfreemap.org/styles/fiord")
        .then((r) => r.json())
        .then((style) => {
          style.projection = { type: "globe" };

          const map = new maplibregl.Map({
            container: "map",
            style,
            center: [0, 15],
            zoom: 3,
            minZoom: 3,
            maxZoom: 3,
            interactive: false,
          });

          map.on("load", () => {
            map.addSource("storms", { type: "vector", url: stormsTilesUrl });

            const firstSymbolLayerId = map
              .getStyle()
              .layers.find((layer) => layer.type === "symbol")?.id;

            map.addLayer(
              {
                id: "storms-line",
                type: "line",
                source: "storms",
                "source-layer": "storms",
                paint: {
                  "line-color": [
                    "interpolate",
                    ["linear"],
                    ["coalesce", ["get", "USA_SSHS"], -1],
                    -1,
                    "#7aa6c7",
                    0,
                    "#4dc9ff",
                    1,
                    "#8bc34a",
                    2,
                    "#ffd166",
                    3,
                    "#f4a261",
                    4,
                    "#e76f51",
                    5,
                    "#c71f37",
                  ],
                  "line-width": [
                    "interpolate",
                    ["linear"],
                    ["coalesce", ["get", "USA_WIND"], 0],
                    0,
                    0.8,
                    50,
                    2,
                    100,
                    3.5,
                    150,
                    5,
                  ],
                  "line-opacity": 0.5,
                },
              },
              firstSymbolLayerId,
            );
          });

          const spinner = createGlobeSpinner(map);
          spinner.start();
        });
    </script>
  </body>
</html>
